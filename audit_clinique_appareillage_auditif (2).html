<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audit Clinique ‚Äì Appareillage Auditif ¬∑ DPC Audioproth√©sistes</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --primary: #1a3a5c;
    --primary-light: #2a5a8c;
    --accent: #00b4d8;
    --accent2: #48cae4;
    --success: #2ecc71;
    --warning: #f39c12;
    --danger: #e74c3c;
    --absent: #95a5a6;
    --na: #8e44ad;
    --bg: #f0f4f8;
    --card: #ffffff;
    --text: #1a1a2e;
    --text-light: #5a6a7a;
    --border: #dce6f0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: linear-gradient(135deg, var(--primary) 0%, #0d2137 100%);
    padding: 24px 40px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }
  header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.5rem;
    font-weight: 400;
    letter-spacing: 0.02em;
  }
  header p {
    font-size: 0.8rem;
    opacity: 0.65;
    margin-top: 3px;
  }
  .header-badge {
    background: rgba(0,180,216,0.2);
    border: 1px solid rgba(0,180,216,0.5);
    color: var(--accent2);
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.05em;
  }

  /* MAIN LAYOUT */
  .app {
    max-width: 1100px;
    margin: 0 auto;
    padding: 32px 20px;
  }

  /* PROGRESS BAR */
  .progress-section {
    background: var(--card);
    border-radius: 16px;
    padding: 20px 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }
  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .progress-header span {
    font-size: 0.85rem;
    color: var(--text-light);
    font-weight: 500;
  }
  .progress-header strong {
    color: var(--primary);
    font-size: 1rem;
  }
  .progress-bar {
    background: var(--border);
    border-radius: 8px;
    height: 8px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--primary-light));
    border-radius: 8px;
    transition: width 0.4s ease;
  }

  /* DOSSIER NAVIGATOR */
  .dossier-nav {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 24px;
  }
  .dossier-btn {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    border: 2px solid var(--border);
    background: var(--card);
    color: var(--text-light);
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .dossier-btn:hover { border-color: var(--accent); color: var(--primary); }
  .dossier-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
  .dossier-btn.complete { border-color: var(--success); }
  .dossier-btn.complete::after {
    content: '‚úì';
    position: absolute;
    top: -6px;
    right: -6px;
    background: var(--success);
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* AUDIT CARD */
  .audit-card {
    background: var(--card);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }
  .audit-card-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  .dossier-number {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    border-radius: 12px;
    padding: 10px 16px;
    font-family: 'DM Serif Display', serif;
    font-size: 1.4rem;
    min-width: 72px;
    text-align: center;
  }
  .dossier-number small {
    display: block;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.6rem;
    opacity: 0.75;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .audit-card-title h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.2rem;
    color: var(--primary);
    font-weight: 400;
  }
  .audit-card-title p {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 2px;
  }

  /* CRITERIA TABLE */
  .criteria-table {
    width: 100%;
    border-collapse: collapse;
  }
  .criteria-table thead tr {
    background: var(--bg);
  }
  .criteria-table thead th {
    padding: 10px 14px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    text-align: left;
    border-bottom: 2px solid var(--border);
  }
  .criteria-table thead th:last-child { text-align: center; }
  .criteria-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }
  .criteria-table tbody tr:hover { background: #f8fbff; }
  .criteria-table tbody tr:last-child { border-bottom: none; }
  .crit-num {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    flex-shrink: 0;
  }
  .criteria-table td {
    padding: 14px;
    vertical-align: top;
  }
  .crit-label {
    font-weight: 600;
    font-size: 0.82rem;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 3px;
  }
  .crit-desc {
    font-size: 0.8rem;
    color: var(--text-light);
    line-height: 1.5;
  }
  .crit-ref {
    font-size: 0.7rem;
    color: var(--accent);
    margin-top: 4px;
  }
  .response-group {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .response-btn {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1.5px solid var(--border);
    background: white;
    font-size: 0.72rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.18s;
    white-space: nowrap;
    color: var(--text-light);
  }
  .response-btn:hover { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
  .response-btn.sel-conforme { background: #e8faf2; border-color: var(--success); color: var(--success); }
  .response-btn.sel-nonconforme { background: #fef0ef; border-color: var(--danger); color: var(--danger); }
  .response-btn.sel-absent { background: #f5f5f5; border-color: var(--absent); color: var(--absent); }
  .response-btn.sel-na { background: #f3eafd; border-color: var(--na); color: var(--na); }

  /* NAVIGATION BUTTONS */
  .nav-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
  }
  .btn {
    padding: 11px 24px;
    border-radius: 10px;
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 0.88rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(26,58,92,0.3); }
  .btn-secondary {
    background: var(--bg);
    color: var(--primary);
    border: 1.5px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent); background: white; }
  .btn-success {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
  }
  .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46,204,113,0.3); }

  /* RESULTS SECTION */
  #results-section { display: none; }
  .results-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }
  @media (max-width: 700px) { .results-grid { grid-template-columns: 1fr; } }

  .result-card {
    background: var(--card);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }
  .result-card h3 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.1rem;
    color: var(--primary);
    margin-bottom: 16px;
    font-weight: 400;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* KPI BOXES */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  @media (max-width: 700px) { .kpi-grid { grid-template-columns: repeat(2,1fr); } }
  .kpi-box {
    background: var(--card);
    border-radius: 14px;
    padding: 18px;
    text-align: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border-top: 4px solid;
  }
  .kpi-box.kpi-conforme { border-color: var(--success); }
  .kpi-box.kpi-nc { border-color: var(--danger); }
  .kpi-box.kpi-absent { border-color: var(--absent); }
  .kpi-box.kpi-na { border-color: var(--na); }
  .kpi-value {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    font-weight: 400;
  }
  .kpi-box.kpi-conforme .kpi-value { color: var(--success); }
  .kpi-box.kpi-nc .kpi-value { color: var(--danger); }
  .kpi-box.kpi-absent .kpi-value { color: var(--absent); }
  .kpi-box.kpi-na .kpi-value { color: var(--na); }
  .kpi-label { font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-light); margin-top: 4px; }

  /* FEEDBACK TABLE */
  .feedback-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
  }
  .feedback-table th {
    background: var(--bg);
    padding: 10px 12px;
    text-align: left;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-light);
    font-weight: 600;
  }
  .feedback-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
    line-height: 1.5;
  }
  .feedback-table tr:last-child td { border-bottom: none; }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 700;
  }
  .badge-conforme { background: #e8faf2; color: var(--success); }
  .badge-nc { background: #fef0ef; color: var(--danger); }
  .badge-absent { background: #f5f5f5; color: var(--absent); }
  .badge-na { background: #f3eafd; color: var(--na); }
  .rate-ok { color: var(--success); font-weight: 700; }
  .rate-warn { color: var(--warning); font-weight: 700; }
  .rate-bad { color: var(--danger); font-weight: 700; }

  /* ACTIONS */
  .action-item {
    background: #fffbf0;
    border-left: 4px solid var(--warning);
    border-radius: 0 10px 10px 0;
    padding: 12px 16px;
    margin-bottom: 10px;
  }
  .action-item.action-critical {
    background: #fff5f5;
    border-color: var(--danger);
  }
  .action-item.action-good {
    background: #f0faf5;
    border-color: var(--success);
  }
  .action-title { font-weight: 600; font-size: 0.85rem; color: var(--text); margin-bottom: 4px; }
  .action-desc { font-size: 0.8rem; color: var(--text-light); line-height: 1.5; }

  /* GLOBAL SCORE */
  .global-score-section {
    background: linear-gradient(135deg, var(--primary) 0%, #0d2137 100%);
    color: white;
    border-radius: 16px;
    padding: 28px 32px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 24px;
    box-shadow: 0 4px 20px rgba(26,58,92,0.3);
  }
  .score-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 4px solid rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    flex-shrink: 0;
  }
  .score-circle .score-num {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    line-height: 1;
  }
  .score-circle small { font-size: 0.65rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.05em; }
  .score-text h2 { font-family: 'DM Serif Display', serif; font-size: 1.4rem; font-weight: 400; margin-bottom: 6px; }
  .score-text p { font-size: 0.85rem; opacity: 0.75; line-height: 1.6; }

  /* CHART CONTAINER */
  .chart-container {
    position: relative;
    height: 340px;
    width: 100%;
  }

  /* PRINT BUTTON */
  .btn-print {
    background: white;
    color: var(--primary);
    border: 1.5px solid var(--border);
    padding: 10px 20px;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-print:hover { border-color: var(--primary); }

  /* DOSSIER ID INPUT */
  .dossier-id-row {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f8fbff;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    margin-bottom: 18px;
  }
  .dossier-id-row label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-light);
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .dossier-id-input {
    flex: 1;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 7px 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    color: var(--text);
    background: white;
    transition: border 0.2s;
    max-width: 320px;
  }
  .dossier-id-input:focus {
    outline: none;
    border-color: var(--accent);
  }
  .dossier-id-hint {
    font-size: 0.72rem;
    color: var(--text-light);
    font-style: italic;
  }

  /* CSV BUTTON */
  .btn-csv {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-csv:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(46,204,113,0.3); }

  /* RESET */
  .reset-section {
    text-align: center;
    margin-top: 20px;
  }

  /* DPC BADGE */
  .dpc-footer {
    text-align: center;
    padding: 20px;
    font-size: 0.72rem;
    color: var(--text-light);
    border-top: 1px solid var(--border);
    margin-top: 32px;
  }

  /* TOOLTIP */
  .tooltip-ref {
    font-size: 0.68rem;
    color: var(--accent);
    font-style: italic;
  }

  /* ANIMATION */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in { animation: fadeIn 0.4s ease forwards; }

  .completion-msg {
    background: linear-gradient(135deg, #e8faf2, #d5f5e9);
    border: 1.5px solid var(--success);
    border-radius: 12px;
    padding: 14px 20px;
    color: #1a6640;
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
</style>
</head>
<body>

<header>
  <div>
    <h1>Audit Clinique ‚Äì Appareillage Auditif</h1>
    <p>√âvaluation des pratiques professionnelles ¬∑ DPC Audioproth√©sistes</p>
  </div>
  <div class="header-badge">EPP ¬∑ 10 Dossiers</div>
</header>

<div class="app">

  <!-- SECTION SAISIE -->
  <div id="saisie-section">

    <!-- Progress -->
    <div class="progress-section">
      <div class="progress-header">
        <span>Progression de l'audit</span>
        <strong id="progress-text">0 / 10 dossiers compl√©t√©s</strong>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width:0%"></div>
      </div>
    </div>

    <!-- Dossier Navigator -->
    <div class="dossier-nav" id="dossier-nav"></div>

    <!-- Audit Form -->
    <div class="audit-card fade-in" id="audit-form">
      <div class="audit-card-header">
        <div class="dossier-number">
          <small>Dossier</small>
          <span id="current-dossier-num">01</span>
        </div>
        <div class="audit-card-title">
          <h2>Grille d'√©valuation ‚Äì 10 crit√®res</h2>
          <p>Renseignez chaque crit√®re : Conforme / Non conforme / Info absente / NA</p>
        </div>
      </div>

      <!-- Identifiant anonymis√© -->
      <div class="dossier-id-row">
        <label>üîí Identifiant dossier</label>
        <input type="text" class="dossier-id-input" id="dossier-id-input" placeholder="Ex : D2024-001, Initiales+DDN‚Ä¶" maxlength="40" oninput="saveDossierId(this.value)" />
        <span class="dossier-id-hint">Anonymis√© ‚Äì Ne pas saisir le nom du patient</span>
      </div>

      <table class="criteria-table">
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th>Crit√®re</th>
            <th style="width:260px;text-align:center">√âvaluation</th>
          </tr>
        </thead>
        <tbody id="criteria-tbody"></tbody>
      </table>

      <div class="nav-actions">
        <button class="btn btn-secondary" id="btn-prev" onclick="prevDossier()">‚Üê Pr√©c√©dent</button>
        <button class="btn btn-primary" id="btn-next" onclick="nextDossier()">Suivant ‚Üí</button>
        <button class="btn btn-success" id="btn-results" onclick="showResults()" style="display:none">üìä Voir les r√©sultats</button>
      </div>
    </div>

  </div>

  <!-- SECTION R√âSULTATS -->
  <div id="results-section" class="fade-in">

    <!-- Score global -->
    <div class="global-score-section" id="global-score-section">
      <div class="score-circle" id="score-circle">
        <span class="score-num" id="score-num">-</span>
        <small>% conformit√©</small>
      </div>
      <div class="score-text">
        <h2 id="score-title">R√©sultats de l'audit clinique</h2>
        <p id="score-comment"></p>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-box kpi-conforme">
        <div class="kpi-value" id="kpi-conforme">-</div>
        <div class="kpi-label">‚úÖ Conforme</div>
      </div>
      <div class="kpi-box kpi-nc">
        <div class="kpi-value" id="kpi-nc">-</div>
        <div class="kpi-label">‚ùå Non conforme</div>
      </div>
      <div class="kpi-box kpi-absent">
        <div class="kpi-value" id="kpi-absent">-</div>
        <div class="kpi-label">‚ö†Ô∏è Info absente</div>
      </div>
      <div class="kpi-box kpi-na">
        <div class="kpi-value" id="kpi-na">-</div>
        <div class="kpi-label">NA</div>
      </div>
    </div>

    <!-- GRID: Radar + Taux par crit√®re -->
    <div class="results-grid">
      <div class="result-card">
        <h3>üï∏Ô∏è Toile d'araign√©e ‚Äì Conformit√© par crit√®re</h3>
        <div class="chart-container">
          <canvas id="radarChart"></canvas>
        </div>
      </div>
      <div class="result-card">
        <h3>üìä Taux de conformit√© par crit√®re</h3>
        <div class="chart-container">
          <canvas id="barChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Feedback par crit√®re -->
    <div class="result-card" style="margin-bottom:24px">
      <h3>üìã Analyse d√©taill√©e par crit√®re</h3>
      <table class="feedback-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Crit√®re</th>
            <th>Taux conformit√©</th>
            <th>D√©tail (10 dossiers)</th>
            <th>Feedback</th>
          </tr>
        </thead>
        <tbody id="feedback-tbody"></tbody>
      </table>
    </div>

    <!-- Actions d'am√©lioration -->
    <div class="result-card" style="margin-bottom:24px">
      <h3>üéØ Plan d'actions d'am√©lioration</h3>
      <div id="actions-container"></div>
    </div>

    <!-- Conclusion DPC -->
    <div class="result-card" style="margin-bottom:24px">
      <h3>üìù Conclusion de l'audit ‚Äì Rapport DPC</h3>
      <div id="conclusion-text" style="font-size:0.85rem; line-height:1.8; color:var(--text-light);"></div>
    </div>

    <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
      <button class="btn-print" id="btn-pdf" onclick="exportPDF()">üñ®Ô∏è Exporter en PDF</button>
      <button class="btn-csv" onclick="exportCSV()">‚¨áÔ∏è Exporter en CSV</button>
      <button class="btn btn-secondary" onclick="resetAudit()">üîÑ Nouvel audit</button>
    </div>

  </div>

  <div class="dpc-footer">
    Outil d'√âvaluation des Pratiques Professionnelles (EPP) ¬∑ Audit Clinique ¬∑ DPC ¬∑ Audioproth√©siste<br>
    R√©f√©rentiels : Arr√™t√© 14/11/2018 ¬∑ Fiche de cadrage ANDPC ¬∑ Coll√®ge National d'Audioproth√®ses ¬∑ 100% Sant√©
  </div>
</div>

<script>
// =====================
// DATA
// =====================
const CRITERIA = [
  {
    num: 1,
    label: "Prise en compte des acouph√®nes",
    desc:  "Je v√©rifie dans le dossier du patient que j'ai pris en compte la pr√©sence √©ventuelle d'acouph√®nes (m√™me non invalidants) pour le choix de l'aide auditive, en raison de leur effet indirect sur le ressenti auditif en phase d'appareillage.",
    ref:   "Simonetti et al. (2022) ‚Äì Brazilian J. Otorhinolaryngology ¬∑ Lee HJ et al. (2022) ‚Äì J. Clinical Medicine ¬∑ Arr√™t√© 14/11/2018"
  },
  {
    num: 2,
    label: "Exposition au bruit nocif",
    desc:  "Je v√©rifie dans le dossier du patient que j'ai pris en compte l'exposition au bruit nocif au cours de sa vie pour le choix de l'aide auditive, afin d'explorer les effets perceptifs li√©s √† une perte d'origine traumatique.",
    ref:   "Alpsoy MY et al. (2021) ‚Äì J. International Advanced Otology ¬∑ Arr√™t√© 14/11/2018"
  },
  {
    num: 3,
    label: "Audiom√©trie tonale en demi-octave",
    desc:  "Je v√©rifie dans le dossier du patient que j'ai analys√© l'audiom√©trie tonale au casque ou aux inserts en 1/2 octave (liminaire et supraliminaire) pour le choix de l'aide auditive, conform√©ment √† la fiche de cadrage ANDPC.",
    ref:   "Kiessling J et al. (2015) ‚Äì J. American Academy of Audiology ¬∑ Fiche de cadrage ANDPC"
  },
  {
    num: 4,
    label: "Seuils d'inconfort (UCL)",
    desc:  "Je v√©rifie dans le dossier du patient que j'ai mesur√© et pris en compte les seuils d'inconfort au casque ou aux inserts pour le choix de l'aide auditive, afin d'optimiser le confort et la performance proth√©tique.",
    ref:   "Mueller GH et al. (2005) ‚Äì J. American Academy of Audiology ¬∑ Arr√™t√© 14/11/2018"
  },
  {
    num: 5,
    label: "Tests vocaux pr√©-proth√©tiques",
    desc:  "Je v√©rifie dans le dossier du patient que j'ai analys√© le test vocal au casque ou aux inserts dans le calme et dans le bruit avant l'appareillage, afin d'√©tablir un pronostic proth√©tique et orienter le choix de l'aide auditive.",
    ref:   "Davidson A et al. (2021) ‚Äì Ear and Hearing ¬∑ Fiche de cadrage ANDPC"
  },
  {
    num: 6,
    label: "R√©glage personnalis√© (J1 √† J8)",
    desc:  "Je v√©rifie dans le dossier du patient que j'ai r√©alis√© un r√©glage sp√©cifique et personnalis√©, diff√©rent du pr√©r√©glage propos√© par le fabricant, en tenant compte des besoins individuels du patient entre J1 et J8.",
    ref:   "Abrams HB et al. (2012) ‚Äì J. American Academy of Audiology ¬∑ Arr√™t√© 14/11/2018"
  },
  {
    num: 7,
    label: "Mesure in-vivo et gain d'insertion (J1 √† J8)",
    desc:  "Je v√©rifie dans le dossier du patient que j'ai impl√©ment√© ou contr√¥l√© mon r√©glage par mesure en oreille r√©elle (gain d'insertion in-vivo) entre J1 et J8, conform√©ment √† la fiche de cadrage ANDPC.",
    ref:   "Amlani AM et al. (2017) ‚Äì Hearing Review ¬∑ Fiche de cadrage ANDPC"
  },
  {
    num: 8,
    label: "Gain proth√©tique imm√©diat tonal et vocal (J1 √† J8)",
    desc:  "Je v√©rifie dans le dossier du patient que j'ai analys√© le gain proth√©tique tonal et le gain proth√©tique vocal dans le calme en contr√¥le imm√©diat entre J1 et J8, conform√©ment √† la fiche de cadrage ANDPC.",
    ref:   "Hawkins D (2004) ‚Äì Seminars in Hearing ¬∑ Jungmin Ahn et al. (2023) ‚Äì Internat. J. Audiology ¬∑ Fiche de cadrage"
  },
  {
    num: 9,
    label: "Gain proth√©tique final tonal et vocal (J15 √† J60)",
    desc:  "Je v√©rifie dans le dossier du patient que j'ai analys√© le gain proth√©tique final tonal, vocal dans le calme et dans le bruit entre J15 et J60, conform√©ment aux recommandations du College National d'Audioprotheses et au 100% Sante.",
    ref:   "Hawkins D (2004) ¬∑ Davidson A et al. (2021) ‚Äì Ear and Hearing ¬∑ Fiche de cadrage ANDPC"
  },
  {
    num: 10,
    label: "Questionnaire de satisfaction (COSI, APHAB)",
    desc:  "Je v√©rifie dans le dossier du patient que j'ai administre et analyse un questionnaire de satisfaction valide (COSI, APHAB ou equivalent) en lien avec les mesures objectives et subjectives lors du post-appareillage (J15 a J60).",
    ref:   "Oosthuizen I et al. (2023) ‚Äì J. Speech, Language, Hearing Research ¬∑ Fiche de cadrage ANDPC"
  }
];

const RESPONSES = [
  { key: 'conforme', label: 'Conforme', cls: 'sel-conforme' },
  { key: 'nonconforme', label: 'Non conforme', cls: 'sel-nonconforme' },
  { key: 'absent', label: 'Info absente', cls: 'sel-absent' },
  { key: 'na', label: 'NA', cls: 'sel-na' }
];

const FEEDBACK_DATA = [
  {
    label: "Prise en compte des acouph√®nes",
    feedback_ok:  "La prise en compte des acouph√®nes dans le choix de l'aide auditive est bien trac√©e. Cette d√©marche contribue √† une prise en charge globale et personnalis√©e du patient.",
    feedback_warn: "La prise en compte des acouph√®nes n'est pas syst√©matiquement document√©e. M√™me non invalidants, ils influencent le ressenti auditif en phase d'appareillage.",
    action: "Int√©grer une case d√©di√©e aux acouph√®nes dans le dossier patient et syst√©matiser son renseignement √† chaque bilan pr√©-proth√©tique."
  },
  {
    label: "Exposition au bruit nocif",
    feedback_ok:  "L'exposition au bruit nocif est bien recens√©e et prise en compte. Cette approche permet d'anticiper les particularit√©s perceptives des pertes traumatiques.",
    feedback_warn: "L'anamn√®se relative √† l'exposition au bruit nocif est insuffisamment document√©e. Les pertes traumatiques pr√©sentent des profils sp√©cifiques n√©cessitant une adaptation du r√©glage.",
    action: "Ajouter un champ d√©di√© dans l'anamn√®se et former l'√©quipe √† son recueil syst√©matique lors du bilan initial."
  },
  {
    label: "Audiom√©trie tonale en demi-octave",
    feedback_ok:  "L'audiom√©trie tonale en demi-octave est bien r√©alis√©e et trac√©e, conform√©ment √† la fiche de cadrage. Cette pratique est essentielle √† l'optimisation de la prise en charge proth√©tique.",
    feedback_warn: "L'audiom√©trie en demi-octave n'est pas syst√©matiquement r√©alis√©e ou trac√©e. Cette mesure est pourtant indispensable √† une prescription audioproth√©tique pr√©cise.",
    action: "V√©rifier que le mat√©riel clinique permet la r√©alisation de l'audiom√©trie en demi-octave et la rendre obligatoire dans le protocole de bilan."
  },
  {
    label: "Seuils d'inconfort (UCL)",
    feedback_ok:  "Les seuils d'inconfort sont bien mesur√©s et pris en compte. Cette √©tape supraliminaire est d√©terminante pour le confort et la satisfaction du patient appareill√©.",
    feedback_warn: "Les mesures de seuil d'inconfort sont absentes de plusieurs dossiers. Sans ces donn√©es, le r√©glage risque d'√™tre inconfortable et de compromettre l'acceptation de l'appareillage.",
    action: "Syst√©matiser la mesure des UCL lors de chaque bilan audiom√©trique initial et les int√©grer obligatoirement au dossier proth√©tique."
  },
  {
    label: "Tests vocaux pr√©-proth√©tiques",
    feedback_ok:  "Les tests vocaux dans le calme et dans le bruit sont bien r√©alis√©s et document√©s avant l'appareillage. Ces mesures permettent un pronostic proth√©tique fiable.",
    feedback_warn: "Les tests vocaux pr√©-proth√©tiques sont insuffisamment r√©alis√©s. Ils constituent un indicateur majeur du pronostic proth√©tique et de la satisfaction attendue.",
    action: "Inscrire les tests vocaux calme et bruit comme √©tapes obligatoires du bilan pr√©-proth√©tique dans le protocole de service."
  },
  {
    label: "R√©glage personnalis√© (J1 √† J8)",
    feedback_ok:  "Le r√©glage personnalis√©, distinct du pr√©r√©glage fabricant, est bien document√©. Cette approche individualis√©e garantit une prise en charge optimale.",
    feedback_warn: "L'adaptation du r√©glage par rapport au pr√©r√©glage fabricant n'est pas suffisamment trac√©e. Un r√©glage g√©n√©rique expose le patient √† une perte de chance.",
    action: "Documenter syst√©matiquement les modifications apport√©es au pr√©r√©glage fabricant et leurs justifications cliniques dans le dossier de suivi."
  },
  {
    label: "Mesure in-vivo et gain d'insertion (J1 √† J8)",
    feedback_ok:  "La mesure in-vivo est bien r√©alis√©e et trac√©e entre J1 et J8. C'est un crit√®re qualit√© majeur, largement reconnu comme b√©n√©fique pour le patient.",
    feedback_warn: "La mesure in-vivo est absente ou non trac√©e dans plusieurs dossiers. Son absence constitue un d√©faut de qualit√© significatif au regard des recommandations.",
    action: "Mettre en place un protocole obligatoire de mesure in-vivo entre J1 et J8, et former tous les audioproth√©sistes √† sa documentation."
  },
  {
    label: "Gain proth√©tique imm√©diat tonal et vocal (J1 √† J8)",
    feedback_ok:  "Les mesures de gain proth√©tique tonal et vocal en contr√¥le imm√©diat sont bien r√©alis√©es et document√©es. Ces indicateurs permettent une √©valuation objective et pr√©coce du r√©glage.",
    feedback_warn: "Le gain proth√©tique tonal et vocal en contr√¥le imm√©diat est insuffisamment document√©. Sans ces mesures, l'efficience du r√©glage ne peut √™tre objectiv√©e.",
    action: "Syst√©matiser la tra√ßabilit√© du gain proth√©tique tonal et vocal lors de chaque s√©ance entre J1 et J8, en compl√©ment des mesures in-vivo."
  },
  {
    label: "Gain proth√©tique final tonal et vocal (J15 √† J60)",
    feedback_ok:  "Le bilan de gain proth√©tique final est bien r√©alis√© et trac√© entre J15 et J60, conform√©ment aux recommandations du College National et au 100% Sante.",
    feedback_warn: "Le bilan de gain proth√©tique final entre J15 et J60 est incomplet ou absent. Cette √©tape est indispensable pour valider l'appareillage et documenter la conformit√© au 100% Sante.",
    action: "Creer une checklist de cloture du dossier integrant le bilan final tonal et vocal, et conditionner la validation administrative a son renseignement."
  },
  {
    label: "Questionnaire de satisfaction (COSI, APHAB)",
    feedback_ok:  "Le questionnaire de satisfaction valide (COSI, APHAB ou equivalent) est bien administre et analyse en lien avec les mesures objectives. Cette demarche est centree sur l'experience du patient.",
    feedback_warn: "Le questionnaire de satisfaction n'est pas systematiquement utilise ou documente. Sans cet outil, la perspective du patient sur son appareillage n'est pas formellement recueillie.",
    action: "Standardiser l'utilisation d'un questionnaire de satisfaction valide (COSI ou APHAB) a chaque bilan final et integrer son analyse au compte rendu de cloture."
  }
];

// =====================
// STATE
// =====================
let currentDossier = 0;
let dossierIds = Array(10).fill("");
let auditData = Array.from({ length: 10 }, () => Array(10).fill(null));
let radarChart = null;
let barChart = null;

// =====================
// INIT
// =====================
function init() {
  renderDossierNav();
  renderCriteria();
  updateUI();
}

function renderDossierNav() {
  const nav = document.getElementById('dossier-nav');
  nav.innerHTML = '';
  for (let i = 0; i < 10; i++) {
    const btn = document.createElement('button');
    btn.className = 'dossier-btn' + (i === currentDossier ? ' active' : '');
    btn.textContent = (i + 1).toString().padStart(2, '0');
    const complete = isDossierComplete(i);
    if (complete) btn.classList.add('complete');
    btn.onclick = () => goToDossier(i);
    nav.appendChild(btn);
  }
}

function renderCriteria() {
  const tbody = document.getElementById('criteria-tbody');
  tbody.innerHTML = '';
  CRITERIA.forEach((crit, i) => {
    const tr = document.createElement('tr');
    const currentVal = auditData[currentDossier][i];
    tr.innerHTML = `
      <td><div class="crit-num">${crit.num}</div></td>
      <td>
        <div class="crit-label">${crit.label}</div>
        <div class="crit-desc">${crit.desc}</div>
        <div class="tooltip-ref">üìé ${crit.ref}</div>
      </td>
      <td>
        <div class="response-group">
          ${RESPONSES.map(r => `
            <button class="response-btn ${currentVal === r.key ? r.cls : ''}"
              data-crit="${i}" data-val="${r.key}"
              onclick="selectResponse(${i}, '${r.key}')">
              ${r.label}
            </button>
          `).join('')}
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function selectResponse(critIdx, val) {
  auditData[currentDossier][critIdx] = val;
  renderCriteria();
  updateUI();
}

function isDossierComplete(dIdx) {
  return auditData[dIdx].every(v => v !== null);
}

function allComplete() {
  return auditData.every((_, i) => isDossierComplete(i));
}

function updateUI() {
  document.getElementById('current-dossier-num').textContent = (currentDossier + 1).toString().padStart(2, '0');
  const completed = auditData.filter((_, i) => isDossierComplete(i)).length;
  document.getElementById('progress-text').textContent = `${completed} / 10 dossiers compl√©t√©s`;
  document.getElementById('progress-fill').style.width = (completed * 10) + '%';
  renderDossierNav();
  document.getElementById('btn-prev').style.display = currentDossier === 0 ? 'none' : 'inline-block';
  document.getElementById('btn-next').style.display = currentDossier === 9 ? 'none' : 'inline-block';
  const btnResults = document.getElementById('btn-results');
  if (allComplete()) {
    btnResults.style.display = 'inline-block';
  } else {
    btnResults.style.display = 'none';
  }
}

function goToDossier(idx) {
  // Save current id before switching
  const input = document.getElementById('dossier-id-input');
  if (input) dossierIds[currentDossier] = input.value;
  currentDossier = idx;
  renderCriteria();
  updateUI();
  // Restore saved id for new dossier
  const inp = document.getElementById('dossier-id-input');
  if (inp) inp.value = dossierIds[currentDossier] || '';
}

function saveDossierId(val) {
  dossierIds[currentDossier] = val;
}

function prevDossier() {
  if (currentDossier > 0) goToDossier(currentDossier - 1);
}

function nextDossier() {
  if (currentDossier < 9) goToDossier(currentDossier + 1);
}

// =====================
// RESULTS
// =====================
function showResults() {
  document.getElementById('saisie-section').style.display = 'none';
  document.getElementById('results-section').style.display = 'block';
  document.getElementById('results-section').classList.add('fade-in');
  computeResults();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function computeResults() {
  // Per-criteria stats
  const critStats = CRITERIA.map((_, ci) => {
    const vals = auditData.map(d => d[ci]);
    const applicable = vals.filter(v => v !== 'na').length;
    const conforme = vals.filter(v => v === 'conforme').length;
    const nc = vals.filter(v => v === 'nonconforme').length;
    const absent = vals.filter(v => v === 'absent').length;
    const na = vals.filter(v => v === 'na').length;
    const rate = applicable > 0 ? Math.round((conforme / applicable) * 100) : null;
    return { conforme, nc, absent, na, applicable, rate };
  });

  // Global
  const totalResponses = auditData.flat();
  const totalConf = totalResponses.filter(v => v === 'conforme').length;
  const totalNC = totalResponses.filter(v => v === 'nonconforme').length;
  const totalAbsent = totalResponses.filter(v => v === 'absent').length;
  const totalNA = totalResponses.filter(v => v === 'na').length;
  const totalApplicable = totalResponses.filter(v => v !== 'na').length;
  const globalRate = totalApplicable > 0 ? Math.round((totalConf / totalApplicable) * 100) : 0;

  // KPIs
  document.getElementById('kpi-conforme').textContent = totalConf;
  document.getElementById('kpi-nc').textContent = totalNC;
  document.getElementById('kpi-absent').textContent = totalAbsent;
  document.getElementById('kpi-na').textContent = totalNA;

  // Score global
  document.getElementById('score-num').textContent = globalRate + '%';
  let scoreTitle, scoreComment, scoreColor;
  if (globalRate >= 80) {
    scoreTitle = "Pratiques conformes ‚Äì Niveau satisfaisant";
    scoreComment = "Le taux de conformit√© global est satisfaisant. Les pratiques cliniques document√©es respectent majoritairement les recommandations en vigueur. Des ajustements cibl√©s permettront d'atteindre l'excellence.";
    scoreColor = '#2ecc71';
  } else if (globalRate >= 60) {
    scoreTitle = "Des axes d'am√©lioration √† travailler";
    scoreComment = "Le taux de conformit√© est moyen. Des lacunes identifi√©es dans plusieurs crit√®res n√©cessitent des actions correctives cibl√©es. Un plan d'am√©lioration structur√© est recommand√©.";
    scoreColor = '#f39c12';
  } else {
    scoreTitle = "Non-conformit√©s importantes identifi√©es";
    scoreComment = "Le taux de conformit√© est insuffisant. Des actions correctives prioritaires sont indispensables pour mettre les pratiques en conformit√© avec les recommandations professionnelles et r√©glementaires.";
    scoreColor = '#e74c3c';
  }
  document.getElementById('score-title').textContent = scoreTitle;
  document.getElementById('score-comment').textContent = scoreComment;
  document.getElementById('score-circle').style.borderColor = scoreColor;

  // Charts
  renderRadarChart(critStats);
  renderBarChart(critStats);

  // Feedback table
  renderFeedbackTable(critStats);

  // Actions
  renderActions(critStats);

  // Conclusion
  renderConclusion(globalRate, critStats);
}

function renderRadarChart(critStats) {
  if (radarChart) radarChart.destroy();
  const labels = CRITERIA.map(c => c.label.substring(0, 22) + (c.label.length > 22 ? '‚Ä¶' : ''));
  const data = critStats.map(s => s.rate !== null ? s.rate : 0);
  const ctx = document.getElementById('radarChart').getContext('2d');
  radarChart = new Chart(ctx, {
    type: 'radar',
    data: {
      labels,
      datasets: [{
        label: 'Conformit√© (%)',
        data,
        backgroundColor: 'rgba(0,180,216,0.15)',
        borderColor: 'rgba(0,180,216,0.8)',
        borderWidth: 2,
        pointBackgroundColor: data.map(v => v >= 80 ? '#2ecc71' : v >= 60 ? '#f39c12' : '#e74c3c'),
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          min: 0, max: 100,
          ticks: { stepSize: 20, font: { size: 10 } },
          pointLabels: { font: { size: 9.5, family: 'DM Sans' }, color: '#1a3a5c' },
          grid: { color: 'rgba(0,0,0,0.08)' },
          angleLines: { color: 'rgba(0,0,0,0.08)' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => `Conformit√© : ${ctx.raw}%`
          }
        }
      }
    }
  });
}

function renderBarChart(critStats) {
  if (barChart) barChart.destroy();
  const labels = CRITERIA.map((c, i) => `C${i + 1}`);
  const data = critStats.map(s => s.rate !== null ? s.rate : 0);
  const colors = data.map(v => v >= 80 ? '#2ecc71' : v >= 60 ? '#f39c12' : '#e74c3c');
  const ctx = document.getElementById('barChart').getContext('2d');
  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Conformit√© (%)',
        data,
        backgroundColor: colors,
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          min: 0, max: 100,
          ticks: { stepSize: 20, font: { size: 11 }, callback: v => v + '%' },
          grid: { color: 'rgba(0,0,0,0.06)' }
        },
        x: {
          ticks: { font: { size: 11, weight: '600' } },
          grid: { display: false }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: (items) => CRITERIA[items[0].dataIndex].label,
            label: (ctx) => `Conformit√© : ${ctx.raw}%`
          }
        }
      }
    }
  });
}

function renderFeedbackTable(critStats) {
  const tbody = document.getElementById('feedback-tbody');
  tbody.innerHTML = '';
  critStats.forEach((s, i) => {
    const tr = document.createElement('tr');
    const rateClass = s.rate === null ? '' : s.rate >= 80 ? 'rate-ok' : s.rate >= 60 ? 'rate-warn' : 'rate-bad';
    const detailBadges = auditData.map((d, di) => {
      const v = d[i];
      const map = { conforme: 'badge-conforme', nonconforme: 'badge-nc', absent: 'badge-absent', na: 'badge-na' };
      const label = { conforme: 'C', nonconforme: 'NC', absent: 'IA', na: 'NA' };
      const idTip = dossierIds[di] ? ` title="D${(di+1).toString().padStart(2,'0')} ‚Äì ${dossierIds[di]}"` : ` title="Dossier ${(di+1).toString().padStart(2,'0')}"`;
      return `<span class="badge ${map[v]}"${idTip}>${label[v]}</span>`;
    }).join(' ');

    const fd = FEEDBACK_DATA[i];
    const feedbackText = s.rate === null ? 'Non applicable' : s.rate >= 80 ? fd.feedback_ok : fd.feedback_warn;

    tr.innerHTML = `
      <td><div class="crit-num" style="width:28px;height:28px;font-size:0.75rem">${i + 1}</div></td>
      <td style="font-weight:600;font-size:0.8rem">${CRITERIA[i].label}</td>
      <td><span class="${rateClass}">${s.rate !== null ? s.rate + '%' : 'NA'}</span></td>
      <td>${detailBadges}</td>
      <td style="font-size:0.78rem;color:#5a6a7a">${feedbackText}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderActions(critStats) {
  const container = document.getElementById('actions-container');
  container.innerHTML = '';
  
  const critical = [];
  const toImprove = [];
  const good = [];

  critStats.forEach((s, i) => {
    if (s.rate === null) return;
    if (s.rate < 60) critical.push(i);
    else if (s.rate < 80) toImprove.push(i);
    else good.push(i);
  });

  if (good.length === critStats.filter(s => s.rate !== null).length) {
    container.innerHTML = `<div class="action-item action-good"><div class="action-title">‚úÖ F√©licitations ‚Äì Pratiques globalement conformes</div><div class="action-desc">L'ensemble des crit√®res atteint un taux de conformit√© satisfaisant. Il est recommand√© de maintenir ce niveau via une d√©marche d'am√©lioration continue et de mettre en place un audit de suivi dans 6 mois.</div></div>`;
    return;
  }

  if (critical.length > 0) {
    const item = document.createElement('div');
    item.className = 'action-item action-critical';
    item.innerHTML = `<div class="action-title">üö® Actions prioritaires ‚Äì Crit√®res critiques (&lt; 60%)</div><div class="action-desc">
      ${critical.map(i => `<strong>C${i + 1} ‚Äì ${CRITERIA[i].label} :</strong> ${FEEDBACK_DATA[i].action}`).join('<br><br>')}
    </div>`;
    container.appendChild(item);
  }

  if (toImprove.length > 0) {
    const item = document.createElement('div');
    item.className = 'action-item';
    item.innerHTML = `<div class="action-title">‚ö†Ô∏è Actions d'am√©lioration ‚Äì Crit√®res √† renforcer (60‚Äì79%)</div><div class="action-desc">
      ${toImprove.map(i => `<strong>C${i + 1} ‚Äì ${CRITERIA[i].label} :</strong> ${FEEDBACK_DATA[i].action}`).join('<br><br>')}
    </div>`;
    container.appendChild(item);
  }

  if (good.length > 0) {
    const item = document.createElement('div');
    item.className = 'action-item action-good';
    item.innerHTML = `<div class="action-title">‚úÖ Points forts ‚Äì Crit√®res conformes (‚â• 80%)</div><div class="action-desc">
      ${good.map(i => `<strong>C${i + 1} ‚Äì ${CRITERIA[i].label}</strong>`).join(', ')} ¬∑ Maintenir le niveau et partager les bonnes pratiques en √©quipe.
    </div>`;
    container.appendChild(item);
  }

  // Recommandation DPC
  const dpcItem = document.createElement('div');
  dpcItem.className = 'action-item';
  dpcItem.style.borderColor = '#1a3a5c';
  dpcItem.style.background = '#f0f4f8';
  dpcItem.innerHTML = `<div class="action-title">üéì Recommandation DPC</div><div class="action-desc">Sur la base de cet audit clinique, il est recommand√© de suivre une ou plusieurs actions DPC portant sur les th√©matiques identifi√©es comme non conformes. Cet audit constitue la phase d'<strong>√âvaluation des Pratiques Professionnelles (EPP)</strong> de votre parcours triennal DPC. Conservez ce rapport pour votre dossier ANDPC.</div>`;
  container.appendChild(dpcItem);
}

function renderConclusion(globalRate, critStats) {
  const critCount = critStats.filter(s => s.rate !== null && s.rate < 60).length;
  const warnCount = critStats.filter(s => s.rate !== null && s.rate >= 60 && s.rate < 80).length;
  const okCount = critStats.filter(s => s.rate !== null && s.rate >= 80).length;
  const date = new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });

  document.getElementById('conclusion-text').innerHTML = `
    <p><strong>Date de r√©alisation de l'audit :</strong> ${date}</p><br>
    <p>Cet audit clinique portant sur la <strong>r√©fraction en renouvellement avec adaptation</strong> a √©t√© r√©alis√© sur 10 dossiers patients. 
    Il √©value la conformit√© des pratiques de l'opticien lunetier au regard des 10 crit√®res d√©finis par les recommandations professionnelles et r√©glementaires (HAS, AOF, Legifrance).</p><br>
    <p><strong>R√©sultat global :</strong> Le taux de conformit√© toutes √©valuations confondues est de <strong>${globalRate}%</strong>.</p>
    <ul style="margin:10px 0 10px 20px;line-height:2">
      <li><strong>${okCount} crit√®re(s)</strong> pr√©sentent un taux de conformit√© satisfaisant (‚â• 80%)</li>
      <li><strong>${warnCount} crit√®re(s)</strong> n√©cessitent des actions d'am√©lioration (60‚Äì79%)</li>
      <li><strong>${critCount} crit√®re(s)</strong> pr√©sentent des non-conformit√©s importantes (&lt; 60%)</li>
    </ul>
    <p>Cet audit s'inscrit dans le cadre du <strong>D√©veloppement Professionnel Continu (DPC)</strong> et de l'<strong>√âvaluation des Pratiques Professionnelles (EPP)</strong>, conform√©ment aux exigences de l'ANDPC pour le parcours triennal de formation des opticiens lunetiers. 
    Les actions d'am√©lioration identifi√©es devront faire l'objet d'un suivi et d'un nouvel audit √† 6 mois.</p><br>
    <p style="font-style:italic;font-size:0.78rem">Document √† conserver dans votre dossier de formation continue DPC.</p><br>
    <p><strong>Dossiers inclus dans l'audit :</strong></p>
    <table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:0.78rem">
      <thead><tr style="background:#f0f4f8">
        <th style="padding:6px 10px;text-align:left;border-bottom:1px solid #dce6f0">N¬∞</th>
        <th style="padding:6px 10px;text-align:left;border-bottom:1px solid #dce6f0">Identifiant anonymis√©</th>
        <th style="padding:6px 10px;text-align:center;border-bottom:1px solid #dce6f0">Conformit√©</th>
        <th style="padding:6px 10px;text-align:center;border-bottom:1px solid #dce6f0">NC</th>
        <th style="padding:6px 10px;text-align:center;border-bottom:1px solid #dce6f0">Info absente</th>
        <th style="padding:6px 10px;text-align:center;border-bottom:1px solid #dce6f0">NA</th>
      </tr></thead>
      <tbody>${auditData.map((d,di)=>{
        const iid = dossierIds[di] || `<em style="color:#aaa">Non renseign√©</em>`;
        const conf=d.filter(v=>v==='conforme').length;
        const nc=d.filter(v=>v==='nonconforme').length;
        const abs=d.filter(v=>v==='absent').length;
        const na=d.filter(v=>v==='na').length;
        const app=d.filter(v=>v!=='na').length;
        const rate=app>0?Math.round(conf/app*100)+'%':'NA';
        const col=conf/app>=0.8?'#2ecc71':conf/app>=0.6?'#f39c12':'#e74c3c';
        return `<tr style="border-bottom:1px solid #f0f4f8">
          <td style="padding:5px 10px;font-weight:700">D${(di+1).toString().padStart(2,'0')}</td>
          <td style="padding:5px 10px">${iid}</td>
          <td style="padding:5px 10px;text-align:center;font-weight:700;color:${col}">${rate}</td>
          <td style="padding:5px 10px;text-align:center">${nc}</td>
          <td style="padding:5px 10px;text-align:center">${abs}</td>
          <td style="padding:5px 10px;text-align:center">${na}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>
  `;
}

function resetAudit() {
  auditData = Array.from({ length: 10 }, () => Array(10).fill(null));
  dossierIds = Array(10).fill('');
  currentDossier = 0;
  if (radarChart) radarChart.destroy();
  if (barChart) barChart.destroy();
  document.getElementById('results-section').style.display = 'none';
  document.getElementById('saisie-section').style.display = 'block';
  renderCriteria();
  updateUI();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// =====================
// PDF EXPORT
// =====================
function exportPDF() {
  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const pageW = 210;
    const pageH = 297;
    const margin = 12;
    const cW = pageW - margin * 2;
    let y = 0;
    let pageNum = 1;

    // ‚îÄ‚îÄ COULEURS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const NAVY   = [26, 58, 92];
    const BLUE   = [42, 90, 140];
    const CYAN   = [0, 180, 216];
    const GREEN  = [46, 204, 113];
    const ORANGE = [243, 156, 18];
    const RED    = [231, 76, 60];
    const GREY   = [90, 106, 122];
    const LGREY  = [220, 230, 240];
    const BGPAGE = [240, 244, 248];
    const WHITE  = [255, 255, 255];

    // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function addPage() {
      pdf.addPage();
      pageNum++;
      y = 28;
      drawPageHeader();
    }

    function checkY(needed) {
      if (y + needed > pageH - 16) { addPage(); }
    }

    function drawPageHeader() {
      pdf.setFillColor(...NAVY);
      pdf.rect(0, 0, pageW, 20, 'F');
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(10);
      pdf.setTextColor(...WHITE);
      pdf.text('Audit Clinique ‚Äì Appareillage Auditif', margin, 9);
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(7);
      pdf.text('EPP ¬∑ DPC Audioprothesistes ¬∑ ' + new Date().toLocaleDateString('fr-FR'), margin, 15);
      pdf.setTextColor(0, 0, 0);
    }

    function drawFooter() {
      const total = pdf.getNumberOfPages();
      for (let p = 1; p <= total; p++) {
        pdf.setPage(p);
        pdf.setFillColor(...BGPAGE);
        pdf.rect(0, pageH - 10, pageW, 10, 'F');
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(6);
        pdf.setTextColor(...GREY);
        pdf.text('EPP ¬∑ Audit Clinique ¬∑ DPC Audioprothesistes ¬∑ Arrete 14/11/2018 ¬∑ Fiche de cadrage ANDPC ¬∑ College National Audioprotheses ¬∑ 100% Sante', margin, pageH - 4.5);
        pdf.text('Page ' + p + ' / ' + total, pageW - margin - 12, pageH - 4.5);
      }
    }

    function sectionTitle(txt, col) {
      col = col || NAVY;
      checkY(14);
      pdf.setFillColor(...col);
      pdf.rect(margin, y, cW, 8, 'F');
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(9);
      pdf.setTextColor(...WHITE);
      pdf.text(txt, margin + 3, y + 5.5);
      pdf.setTextColor(0, 0, 0);
      y += 10;
    }

    function infoRow(label, value, valueColor) {
      checkY(8);
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(8);
      pdf.setTextColor(...GREY);
      pdf.text(label, margin, y);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(...(valueColor || [30, 30, 30]));
      pdf.text(String(value), margin + 50, y);
      y += 6;
    }

    // ‚îÄ‚îÄ COMPUTE STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const stats = CRITERIA.map((c, ci) => {
      const vals = auditData.map(d => d[ci]);
      const applicable = vals.filter(v => v !== 'na' && v !== null);
      const conformes  = applicable.filter(v => v === 'conforme');
      const rate = applicable.length > 0 ? Math.round(conformes.length / applicable.length * 100) : null;
      return { label: c.label, vals, applicable: applicable.length, conformes: conformes.length, rate };
    });

    const validStats = stats.filter(s => s.rate !== null);
    const globalRate = validStats.length > 0
      ? Math.round(validStats.reduce((a, s) => a + s.rate, 0) / validStats.length)
      : 0;

    const completedDossiers = auditData.filter(d => d.every(v => v !== null)).length;
    const critAbove80 = stats.filter(s => s.rate !== null && s.rate >= 80).length;
    const critBelow60 = stats.filter(s => s.rate !== null && s.rate < 60).length;

    // ‚îÄ‚îÄ PAGE 1 : EN-T√äTE + SYNTH√àSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    drawPageHeader();
    y = 28;

    // Bloc titre principal
    pdf.setFillColor(...CYAN);
    pdf.rect(margin, y, cW, 1.5, 'F');
    y += 4;
    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(16);
    pdf.setTextColor(...NAVY);
    pdf.text('Rapport d\'Evaluation des Pratiques Professionnelles', margin, y);
    y += 7;
    pdf.setFont('helvetica', 'normal');
    pdf.setFontSize(10);
    pdf.setTextColor(...BLUE);
    pdf.text('Audit Clinique ‚Äì Appareillage Auditif (Pre-appareillage J0, Appareillage J1-J8, Post-appareillage J15-J60)', margin, y);
    y += 4;
    pdf.setFillColor(...CYAN);
    pdf.rect(margin, y, cW, 1, 'F');
    y += 8;

    // Infos g√©n√©rales
    sectionTitle('Informations generales');
    const dateStr = new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
    infoRow('Date du rapport :', dateStr);
    infoRow('Nombre de dossiers audites :', completedDossiers + ' / 10');
    infoRow('Referentiels :', 'Arrete 14/11/2018 ¬∑ Fiche de cadrage ANDPC ¬∑ College National Audioprotheses');
    y += 4;

    // Score global
    sectionTitle('Score global de conformite');
    const rateCol = globalRate >= 80 ? GREEN : globalRate >= 60 ? ORANGE : RED;
    const rateLabel = globalRate >= 80 ? 'SATISFAISANT' : globalRate >= 60 ? 'A AMELIORER' : 'INSUFFISANT';

    // Grand score visuel
    checkY(30);
    pdf.setFillColor(...rateCol);
    pdf.roundedRect(margin, y, 50, 22, 3, 3, 'F');
    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(22);
    pdf.setTextColor(...WHITE);
    pdf.text(globalRate + '%', margin + 8, y + 14);
    pdf.setFontSize(8);
    pdf.text(rateLabel, margin + 5, y + 19);

    // KPIs √† droite
    const kpis = [
      { label: 'Dossiers completes', val: completedDossiers + '/10', col: BLUE },
      { label: 'Criteres conformes', val: critAbove80 + '/10', col: GREEN },
      { label: 'Criteres insuffisants', val: critBelow60 + '/10', col: RED },
    ];
    let kx = margin + 56;
    kpis.forEach(k => {
      pdf.setFillColor(248, 251, 255);
      pdf.roundedRect(kx, y, 42, 22, 2, 2, 'F');
      pdf.setDrawColor(...LGREY);
      pdf.roundedRect(kx, y, 42, 22, 2, 2, 'S');
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(14);
      pdf.setTextColor(...k.col);
      pdf.text(String(k.val), kx + 4, y + 13);
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(7);
      pdf.setTextColor(...GREY);
      pdf.text(k.label, kx + 4, y + 19);
      kx += 46;
    });
    y += 28;

    // ‚îÄ‚îÄ PAGE 2 : TABLEAU PAR CRIT√àRE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    sectionTitle('Analyse detaillee par critere');

    // En-t√™te tableau
    const colW = [6, 68, 14, 88];  // #, Crit√®re, Taux, Dossiers
    checkY(10);
    pdf.setFillColor(220, 230, 240);
    pdf.rect(margin, y, cW, 7, 'F');
    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(7);
    pdf.setTextColor(...GREY);
    let cx = margin + 1;
    ['#', 'Critere', 'Taux', 'D1  D2  D3  D4  D5  D6  D7  D8  D9  D10'].forEach((h, hi) => {
      pdf.text(h, cx + 1, y + 4.8);
      cx += colW[hi];
    });
    y += 7;

    stats.forEach((s, i) => {
      const rowH = 11;
      checkY(rowH + 1);

      // Fond altern√©
      if (i % 2 === 0) {
        pdf.setFillColor(248, 251, 255);
        pdf.rect(margin, y, cW, rowH, 'F');
      }

      cx = margin + 1;

      // Num√©ro
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(8);
      pdf.setTextColor(...NAVY);
      pdf.text(String(i + 1), cx + 1, y + 6);
      cx += colW[0];

      // Libell√© (sur 2 lignes si besoin)
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(7);
      pdf.setTextColor(...NAVY);
      const lblLines = pdf.splitTextToSize(s.label, colW[1] - 2);
      pdf.text(lblLines.slice(0, 2), cx, y + 4.5);
      cx += colW[1];

      // Taux
      const rCol = s.rate === null ? GREY : s.rate >= 80 ? GREEN : s.rate >= 60 ? ORANGE : RED;
      const rStr = s.rate !== null ? s.rate + '%' : 'NA';
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(8.5);
      pdf.setTextColor(...rCol);
      pdf.text(rStr, cx + 1, y + 6);
      cx += colW[2];

      // Badges D1‚ÜíD10
      const BADGE_COLORS = { conforme: GREEN, nonconforme: RED, absent: [149, 165, 166], na: [142, 68, 173] };
      const BADGE_LABELS = { conforme: 'C', nonconforme: 'NC', absent: 'IA', na: 'NA' };
      let bx = cx;
      s.vals.forEach((v, vi) => {
        if (v === null) return;
        const bc = BADGE_COLORS[v] || GREY;
        const bl = BADGE_LABELS[v] || '?';
        const bw = v === 'nonconforme' ? 6.5 : 5;
        pdf.setFillColor(...bc);
        pdf.roundedRect(bx, y + 2.5, bw, 5, 0.8, 0.8, 'F');
        pdf.setFont('helvetica', 'bold');
        pdf.setFontSize(5.5);
        pdf.setTextColor(...WHITE);
        pdf.text(bl, bx + 0.8, y + 6.5);
        bx += bw + 1.2;
      });

      y += rowH;
      pdf.setDrawColor(...LGREY);
      pdf.line(margin, y, margin + cW, y);
    });
    y += 6;

    // L√©gende badges
    checkY(12);
    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(7);
    pdf.setTextColor(...GREY);
    pdf.text('Legende : ', margin, y);
    const legend = [['C', GREEN, 'Conforme'], ['NC', RED, 'Non conforme'], ['IA', [149,165,166], 'Info absente'], ['NA', [142,68,173], 'Non applicable']];
    let lx = margin + 20;
    legend.forEach(([lbl, col, txt]) => {
      pdf.setFillColor(...col);
      pdf.roundedRect(lx, y - 4, lbl === 'NC' ? 6.5 : 5, 5, 0.8, 0.8, 'F');
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(5.5);
      pdf.setTextColor(...WHITE);
      pdf.text(lbl, lx + 0.8, y - 0.3);
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(7);
      pdf.setTextColor(...GREY);
      pdf.text(txt, lx + (lbl === 'NC' ? 8 : 6.5), y - 0.3);
      lx += 30;
    });
    y += 8;

    // ‚îÄ‚îÄ FEEDBACKS PAR CRIT√àRE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    sectionTitle('Feedbacks et actions par critere', BLUE);

    stats.forEach((s, i) => {
      const fd = FEEDBACK_DATA[i];
      const isOk = s.rate !== null && s.rate >= 80;
      const fbText = s.rate === null ? 'Critere non applicable.' : isOk ? fd.feedback_ok : fd.feedback_warn;
      const action = (!isOk && s.rate !== null) ? fd.action : null;

      const lines1 = pdf.splitTextToSize(fbText, cW - 20);
      const lines2 = action ? pdf.splitTextToSize('Action : ' + action, cW - 20) : [];
      const blockH = 8 + lines1.length * 4.5 + (lines2.length > 0 ? 2 + lines2.length * 4 : 0) + 4;

      checkY(blockH);

      // Fond
      const bgCol = isOk ? [232, 250, 240] : [255, 248, 240];
      pdf.setFillColor(...bgCol);
      pdf.roundedRect(margin, y, cW, blockH - 2, 2, 2, 'F');

      // Num√©ro + label
      const numCol = isOk ? GREEN : s.rate !== null ? (s.rate >= 60 ? ORANGE : RED) : GREY;
      pdf.setFillColor(...numCol);
      pdf.roundedRect(margin + 2, y + 2, 6, 6, 1, 1, 'F');
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(7);
      pdf.setTextColor(...WHITE);
      pdf.text(String(i + 1), margin + 3.5, y + 6.3);

      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(7.5);
      pdf.setTextColor(...NAVY);
      const shortLabel = s.label.length > 55 ? s.label.substring(0, 53) + '...' : s.label;
      pdf.text(shortLabel, margin + 10, y + 5.5);

      // Taux badge
      const rateStr2 = s.rate !== null ? s.rate + '%' : 'NA';
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(7);
      pdf.setTextColor(...numCol);
      pdf.text(rateStr2, margin + cW - 14, y + 5.5);
      y += 9;

      // Feedback text
      pdf.setFont('helvetica', isOk ? 'normal' : 'italic');
      pdf.setFontSize(7);
      pdf.setTextColor(50, 50, 50);
      pdf.text(lines1, margin + 4, y);
      y += lines1.length * 4.5;

      // Action
      if (lines2.length > 0) {
        y += 1;
        pdf.setFont('helvetica', 'bold');
        pdf.setFontSize(6.5);
        pdf.setTextColor(...ORANGE);
        pdf.text(lines2, margin + 4, y);
        y += lines2.length * 4;
      }
      y += 5;
    });

    // ‚îÄ‚îÄ PLAN D'ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const actionsNeeded = stats.filter(s => s.rate !== null && s.rate < 80);
    if (actionsNeeded.length > 0) {
      sectionTitle("Plan d'actions d'amelioration prioritaires", [192, 57, 43]);
      
      actionsNeeded.sort((a, b) => (a.rate || 0) - (b.rate || 0)).forEach((s, i) => {
        const fd = FEEDBACK_DATA[stats.indexOf(s)];
        const actionLines = pdf.splitTextToSize((i + 1) + '. [Critere ' + (stats.indexOf(s) + 1) + '] ' + s.label + ' (' + s.rate + '%) ‚Äî ' + fd.action, cW - 6);
        checkY(actionLines.length * 4.5 + 5);
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(7.5);
        pdf.setTextColor(30, 30, 30);
        pdf.text(actionLines, margin + 3, y);
        y += actionLines.length * 4.5 + 3;
      });
      y += 4;
    }

    // ‚îÄ‚îÄ CONCLUSION DPC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    sectionTitle('Conclusion ‚Äì Engagement DPC', NAVY);
    checkY(40);

    const conclusionLines = [
      'Cet audit a ete realise dans le cadre du parcours triennal de Developpement Professionnel Continu (DPC)',
      'conformement a la reglementation en vigueur (Arrete du 14 novembre 2018).',
      '',
      'Taux global de conformite : ' + globalRate + '% (' + rateLabel + ')',
      'Criteres conformes (>= 80%) : ' + critAbove80 + ' / ' + validStats.length,
      'Criteres a ameliorer (< 80%) : ' + (validStats.length - critAbove80) + ' / ' + validStats.length,
      '',
      'L\'analyse de ces resultats permet d\'identifier les axes prioritaires d\'amelioration des pratiques',
      'professionnelles et constitue le point de depart du plan d\'actions correctrices.',
    ];

    conclusionLines.forEach(line => {
      if (line === '') { y += 3; return; }
      checkY(6);
      const isBold = line.includes('Taux global') || line.includes('Criteres');
      pdf.setFont('helvetica', isBold ? 'bold' : 'normal');
      pdf.setFontSize(8);
      pdf.setTextColor(30, 30, 30);
      const splitLines = pdf.splitTextToSize(line, cW - 4);
      pdf.text(splitLines, margin + 2, y);
      y += splitLines.length * 5;
    });

    y += 8;
    // Signature
    checkY(20);
    pdf.setDrawColor(...LGREY);
    pdf.line(margin, y, margin + 60, y);
    pdf.setFont('helvetica', 'normal');
    pdf.setFontSize(7);
    pdf.setTextColor(...GREY);
    pdf.text('Signature et date de validation', margin, y + 5);

    // ‚îÄ‚îÄ FOOTER TOUTES PAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    drawFooter();

    // ‚îÄ‚îÄ SAUVEGARDE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const date = new Date().toISOString().slice(0, 10);
    pdf.save('audit_clinique_appareillage_auditif_' + date + '.pdf');

  } catch(e) {
    console.error('Erreur PDF:', e);
    alert('Erreur export PDF : ' + e.message);
  }
}


// =====================
// CSV EXPORT
// =====================
function exportCSV() {
  const RESP_LABEL = { conforme: 'Conforme', nonconforme: 'Non conforme', absent: 'Info absente', na: 'NA' };
  const critHeaders = CRITERIA.map((c, i) => `C${i+1} - ${c.label}`);
  const header = ['Dossier N¬∞', 'Identifiant anonymis√©', ...critHeaders, 'Total Conforme', 'Total NC', 'Total Info absente', 'Total NA'];

  const rows = auditData.map((dossier, di) => {
    const id = dossierIds[di] || '';
    const vals = dossier.map(v => RESP_LABEL[v] || '');
    const conf = dossier.filter(v => v === 'conforme').length;
    const nc = dossier.filter(v => v === 'nonconforme').length;
    const abs = dossier.filter(v => v === 'absent').length;
    const na = dossier.filter(v => v === 'na').length;
    return [`Dossier ${(di+1).toString().padStart(2,'0')}`, id, ...vals, conf, nc, abs, na];
  });

  // Synthesis row
  const critRates = CRITERIA.map((_, ci) => {
    const vals = auditData.map(d => d[ci]);
    const app = vals.filter(v => v !== 'na').length;
    const conf = vals.filter(v => v === 'conforme').length;
    return app > 0 ? Math.round(conf/app*100)+'%' : 'NA';
  });
  const totalFlat = auditData.flat();
  const synthRow = ['SYNTH√àSE', 'Taux de conformit√© par crit√®re',
    ...critRates,
    totalFlat.filter(v=>v==='conforme').length,
    totalFlat.filter(v=>v==='nonconforme').length,
    totalFlat.filter(v=>v==='absent').length,
    totalFlat.filter(v=>v==='na').length
  ];

  const csvContent = [header, ...rows, [], synthRow]
    .map(row => row.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(';'))
    .join('\n');

  const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().slice(0,10);
  a.href = url;
  a.download = `audit_clinique_appareillage_auditif_${date}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// =====================
// BOOT
// =====================
init();
</script>
</body>
</html>
